# WordPress Contents Migration Tool

## 概要 (Overview)
このツールは、WordPressのエクスポートファイル (`export.xml`) 内のコンテンツに含まれる古い画像URLを、新しいメディアライブラリのURLに一括で置換するためのPythonスクリプトです。

Movable TypeからWordPressへの移行などで発生する、古いパス形式 (`/assets_c/`, `/today/images/` など) を持つ画像リンクを解決し、不要なHTMLタグや属性をクリーンアップして、新しいWordPressサイトにインポート可能なXMLファイルを生成します。

## 主な機能 (Features)
- **XMLファイルの入出力**: `export.xml` を入力とし、修正済みの `import.xml` を出力します。
- **URLの一括置換**: メディアライブラリの情報を元に、コンテンツ内の古いURLを新しいURLに置換します。
- **複数パターンのURLに対応**: `/assets_c/` や `/today/images/` を含む複数の古いパス形式を処理対象とします。
- **サムネイル名の整形**: `...-thumb-320x240.jpg` のようなサムネイルファイル名を、元のファイル名 (`...jpg`) に自動で整形します。
- **大文字/小文字の無視**: ファイル名の照合時に大文字と小文字を区別しません。
- **リンクの解除**: `<a>` タグで囲まれた `<img>` タグから、外側の `<a>` タグを削除します。
- **不要な属性の削除**: `<img>` タグからレイアウトに影響する `class`, `width`, `height` 属性を削除します。
- **テキストリンクの画像化**: 古い画像ページへのテキストリンクを、適切な `<img>` タグに置換します。
- **CDATAセクションの維持**: WordPressのインポート要件に合わせ、コンテンツを `<![CDATA[...]]>` で囲んで出力します。
- **詳細なロギング**: すべての処理内容、成功、スキップ、エラーを `migration.log` ファイルに記録します。

## 必要なもの (Requirements)
- Python 3.6 以上
- 以下のPythonライブラリ:
  - `lxml`
  - `requests`
  - `beautifulsoup4`

## インストール (Installation)
1. このリポジトリをクローンまたはダウンロードします。
2. ターミナルで以下のコマンドを実行し、必要なライブラリをインストールします。
   ```bash
   pip install lxml requests beautifulsoup4
   ```
   または、`requirements.txt` を作成して管理することも推奨します。
   ```
   # requirements.txt
   lxml
   requests
   beautifulsoup4
   ```
   ```bash
   pip install -r requirements.txt
   ```

## 使い方 (Usage)
1. **ファイルの準備**: スクリプト (`migration_tool.py`) と同じディレクトリに、WordPressからエクスポートした `export.xml` を配置します。
   **※注**: メディアライブラリに画像を追加・変更した場合は、必ず最新の状態でエクスポートした `export.xml` を使用してください。

2. **(任意)設定の変更**: `migration_tool.py` の先頭にある設定項目を必要に応じて変更します。
   ```python
   # --- 設定項目 ---
   INPUT_XML_FILE = 'export.xml'
   OUTPUT_XML_FILE = 'import.xml'
   LOG_FILE = 'migration.log'
   ```
3. **スクリプトの実行**: ターミナルで以下のコマンドを実行します。
   ```bash
   python migration_tool.py
   ```
4. **結果の確認**: 処理が完了すると、同じディレクトリに以下のファイルが生成されます。
   - `import.xml`: 修正済みのWordPressインポート用ファイル。このファイルをWordPressにインポートします。
   - `migration.log`: 処理の詳細ログ。エラーやスキップされた項目を確認できます。

## 処理ロジックの詳細 (Processing Logic)
このスクリプトは、コンテンツ内のタグを以下の優先順位で処理することで、意図しない上書きや処理漏れを防いでいます。HTMLの構文（クオートの有無、改行など）の差異を吸収するため、`BeautifulSoup` ライブラリによるHTML解析を全面的に採用しています。

1.  **テキストリンク (`<a>`) の処理**: まず、画像を含まないテキストリンク（`href` に `/assets_c/` を含むもの）を探し出し、適切な `<img>` タグに置換します。
2.  **すべての画像 (`<img>`) の処理**: 次に、コンテンツ内のすべての `<img>` タグを処理対象とします。
    - **リンク付き画像 (`<a><img>`)**: `<img>` タグを処理する際に、親が `<a>` タグであれば、`<a>` タグごと削除（`<img>` タグで置き換え）します。
    - **単独の画像 (`<img>`)**: 単独の `<img>` タグも同様に処理します。

また、置換対象となる画像のファイル名は、`<img>` タグの `alt` 属性ではなく、**常に `src` 属性のURLからサムネイル部分を削除して推測する**ロジックに統一されています。

## 注意事項 (Notes)
- 処理を実行する前に、必ず元の `export.xml` ファイルのバックアップを作成してください。
- 処理対象のXMLファイルのサイズが大きい場合、完了までに時間がかかることがあります。
- このスクリプトは、処理の一部で外部サイト（古いHTMLページなど）へHTTPリクエストを送信します。ファイアウォールなどの環境によっては、アクセスがブロックされる可能性があります。

## Special Thanks
- Gemini 2.5 Pro
